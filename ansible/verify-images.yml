---
- name: Verify synchronized images in target registry
  hosts: localhost
  gather_facts: no
  vars_files:
    - ../ansible/vault.yml
    - ../config/images.yml

  vars:
    _input_target_registry: "{{ target_registry | default('') }}"

  tasks:
    - name: Set actual target_registry
      set_fact:
        real_target_registry: >-
          {{ 
            (_input_target_registry | trim) 
            | ternary(_input_target_registry, vault_registry_url) 
          }}
        api_url: "https://{{ real_target_registry }}/v2"

    - name: Initialize counters
      set_fact:
        success_count: 0
        failure_count: 0

    - name: Verify each image via HTTP API (Basic Auth)
      vars:
        image_name: "{{ item.split(':')[0] }}"
        image_tag: "{{ item.split(':')[1] }}"
      ansible.builtin.uri:
        url: "https://{{ vault_registry_url }}/v2/{{ image_name }}/manifests/{{ image_tag }}"
        method: GET
        user: "{{ vault_registry_username }}"
        password: "{{ vault_registry_password }}"
        force_basic_auth: yes
        validate_certs: no
        headers:
          Accept: "application/vnd.docker.distribution.manifest.v2+json"
        status_code: [200]
      register: verify_result
      failed_when: verify_result.status != 200
      ignore_errors: yes
      loop: "{{ images }}"
      loop_control:
        label: "{{ item }}"

    - name: Count results
      set_fact:
        success_count: "{{ verify_result.results | selectattr('status', 'defined') | selectattr('status', 'equalto', 200) | list | length }}"
        failure_count: "{{ verify_result.results | rejectattr('status', 'equalto', 200) | list | length }}"

    - name: Show verification summary
      ansible.builtin.debug:
        msg: |
          成功镜像数: {{ success_count }}
          失败镜像数: {{ failure_count }}

    - name: Fail if there are any failed verifications
      ansible.builtin.fail:
        msg: "发现 {{ failure_count }} 个镜像未成功同步！"
      when: failure_count | int > 0
